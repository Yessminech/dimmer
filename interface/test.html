<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Light Control Interface</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --background-color: #f5f5f5;
            --text-color: #333;
            --slider-background: #ddd;
            --slider-focus-background: #c0ddf5;
            --switch-background: #ccc;
            --switch-checked-background: #007bff;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 20px;
        }

        .slider {
            width: 100%;
            height: 25px;
            background: var(--slider-background);
            border-radius: 5px;
            outline: none;
            transition: background 0.3s ease;
        }

        .slider:focus {
            background: var(--slider-focus-background);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch_slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--switch-background);
            transition: 0.4s;
            border-radius: 34px;
        }

        .switch_slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.switch_slider {
            background-color: var(--switch-checked-background);
        }

        input:checked+.switch_slider:before {
            transform: translateX(26px);
        }

        .narrow-select {
            width: 950px;
            /* Adjust the width as needed */
        }

        .wide-select {
            width: 1000px;
            /* Adjust the width as needed */
        }

        .card {
            margin-bottom: 20px;
        }

        .card-body {
            padding: 20px;
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .d-flex .btn-block {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="my-4 text-center">Light Control Interface</h2>

        <!-- Profile Card -->
        <div class="card mb-4">
            <div class="card-body">
                <p class="card-text">Select a Profile:</p>
                <div class="d-flex mb-3">
                    <select name="profiles" id="profiles" class="form-control mr-2"
                        onchange="selectProfile()">
                        <option value="" selected>Choose your Profile</option>
                    </select>
                </div>
                <div class="d-flex justify-content-center mt-3">
                    <input type="file" id="profileUpload" accept=".json" onchange="importProfile(event)">
                    <!-- <button class="btn btn-secondary mx-2" onclick="reloadProfiles()">Reload Profiles Lamps</button> -->
                </div>
            </div>
        </div>
        <!-- Lamp Control Card -->
        <div class="card mb-4">
            <div class="card-body">
                <p class="card-text">Select Lamps to Control Brightness</p>
                <div class="d-flex mb-3">
                    <select name="lamps" id="lamps" class="form-control mr-2 narrow-select" onchange="displayLamp()">
                        <option value="" selected>Choose your Lamp</option>
                    </select>
                    <button class="btn btn-primary" onclick="addLamp()">Add Lamp</button>
                </div>
                <div id="lampControls"></div>
                <div class="d-flex justify-content-center mt-3">
                    <button class="btn btn-secondary mx-2" onclick="reset()">Reset Lamps</button>
                    <button class="btn btn-success mx-2" onclick="addAndExportProfile()">Export Profile</button>
                </div>
            </div>
        </div>


    </div>

    <script>
        let lampMax = 9;
        // let lampConnected = prompt("Enter the number Lamps to control:"); 
        // if (lampConnected > lampMax) {
        //     alert("The maximum number of lamps is " + lampMax + ". Please enter a number less than or equal to " + lampMax + ".");
        //     lampConnected = lampMax;
        // }
        let lampConnected = 9 //TODO
        let lampCounter = -1;
        let lampState = {};
        let profiles = {};
        let deletedLampIds = []; 

        // Lamps control functions //

        // Add a new lamp to the list
        function addLamp() {
            if (document.getElementById('profiles').value === "") {
                alert("Please select a profile before adding a lamp.");
                return;
            }
            
            if (lampCounter >= lampConnected && deletedLampIds.length === 0) {
                alert("The maximum number of lamps is " + lampConnected + ". Please remove a lamp before adding a new one.");
                return;
            }
            const lampName = prompt("Enter the name of the lamp:");
            if (lampName) {
                const lampsDropdown = document.getElementById('lamps');
                const existingLamp = Array.from(lampsDropdown.options).find(option => option.text === lampName);
                if (existingLamp) {
                    alert("Lamp name already exists. Please choose a different name.");
                    return;
                }
                
                let lampId;
                if (deletedLampIds.length > 0) {
                    lampId = deletedLampIds.pop(); // Reuse the last deleted lamp ID
                    lampCounter++;
                } else {
                    lampId = ++lampCounter; // Use a new lamp ID
                }
                const option = document.createElement('option');
                option.value = lampId;
                option.text = lampName;
                lampsDropdown.add(option);
                lampState[lampId] = {id: lampId, name: lampName, brightness: 100, isOn: true };
                // Set the new lamp as selected
                lampsDropdown.value = lampId;
                displayLamp();
            }
        }

        // Remove the selected lamp from the list
        function removeLamp(lamp) {
            const lampControl = document.getElementById(`lampControl${lamp}`);
            if (lampControl) {
                lampControl.remove();
            }
            const lampsDropdown = document.getElementById('lamps');
            for (let i = 0; i < lampsDropdown.options.length; i++) {
                const option = lampsDropdown.options[i];
                if (option.value === lamp.toString()) {
                    option.selected = false;
                    lampsDropdown.remove(i);
                    break;
                }
            }
            lampCounter--;
            deletedLampIds.push(lamp); 
            delete lampState[lamp];
            // Select the last remaining lamp option if any
            if (lampsDropdown.options.length > 0) {
                lampsDropdown.selectedIndex = lampsDropdown.options.length - 1;
                displayLamp();
            } else {
                document.getElementById('lampControls').innerHTML = '';
            }
        }

        //TODO Correct this! 
        // Remove all lamps 
        function removeAllLamps() {
            const lampsDropdown = document.getElementById('lamps');
            lampsDropdown.innerHTML = '';
            lampState = {};
            lampCounter = 0;
        }

        // Reset all lamps to 100% brightness
        function reset() {
            Object.keys(lampState).forEach(lamp => {
                lampState[lamp].brightness = 100;
                const slider = document.getElementById(`pwmSlider${lamp}`);
                if (slider) {
                    slider.value = 100;
                    document.getElementById(`textSliderValue${lamp}`).innerText = 100;
                }
                fetch(`/brightness?lamp=${lamp}&value=100`);
                lampState[lamp].isOn = true;
                const switchElement = document.getElementById(`lamp${lamp}Switch`);
                if (switchElement) {
                    switchElement.checked = true;
                }
                fetch(`/toggle?lamp=${lamp}&value=100`);
            });
        }

        // Display the selected lamps with brightness control
        function displayLamp() {
            const selectedLamps = Array.from(document.getElementById('lamps').selectedOptions); // Convert selectedOptions to an array
            const lampControls = document.getElementById('lampControls');
            lampControls.innerHTML = '';
            selectedLamps.forEach(lamp => {
            if (lamp.value === document.getElementById('lamps').value) {
                lampControls.innerHTML += generateLampControlHTML(lamp.value, lamp.text); // Use lamp.value for id and lamp.text for name
            }
            });
        }

        function generateLampControlHTML(lamp, lampName) {
            const { id , name , brightness, isOn } = lampState[lamp];
            return `
                <div id="lampControl${lamp}" class="my-3 row align-items-center">
                    <div class="col-md-3">
                        <span>Brightness Level: <span id="textSliderValue${lamp}">${brightness}</span>%</span>
                    </div>
                    <div class="col-md-6 d-flex justify-content-center align-items-center">
                        <button class="btn btn-outline-secondary" onclick="decreaseSliderValue(${lamp})">-</button>
                        <input type="range" id="pwmSlider${lamp}" min="0" max="100" value="${brightness}" class="slider mx-2" aria-label="${lampName} Brightness" style="width: 450px;" oninput="updateSliderPWM(${lamp}, this)">
                        <button class="btn btn-outline-secondary" onclick="increaseSliderValue(${lamp})">+</button>
                        <label class="switch ml-2" style="width: 70px;">
                            <input type="checkbox" id="lamp${lamp}Switch" class="toggle-switch" onclick="toggleLamp(${lamp})" ${isOn ? 'checked' : ''}>
                            <span class="switch_slider"></span>
                        </label>
                    </div>
                    <div class="col-md-3 text-right">
                        <button class="btn btn-danger mx-2" onclick="removeLamp(${lamp})">Remove</button>
                    </div>
                </div>
            `;
        }

        // Slider control functions
        function updateSliderPWM(lamp, element) {
            const sliderValue = element.value;
            document.getElementById(`textSliderValue${lamp}`).innerText = sliderValue;
            lampState[lamp].brightness = sliderValue;
            fetch(`/brightness?lamp=${lamp}&value=${sliderValue}`);
            const checkbox = document.getElementById(`lamp${lamp}Switch`);
            checkbox.checked = sliderValue > 0;
            lampState[lamp].isOn = sliderValue > 0;
        }
        function increaseSliderValue(lamp) {
            const slider = document.getElementById(`pwmSlider${lamp}`);
            const newValue = Math.min(parseInt(slider.value) + 1, 100);
            slider.value = newValue;
            document.getElementById(`textSliderValue${lamp}`).innerText = newValue;
            const checkbox = document.getElementById(`lamp${lamp}Switch`);
            checkbox.checked = newValue > 0;
            lampState[lamp].brightness = newValue;
            fetch(`/brightness?lamp=${lamp}&value=${newValue}`);
        }
        function decreaseSliderValue(lamp) {
            const slider = document.getElementById(`pwmSlider${lamp}`);
            const newValue = Math.max(parseInt(slider.value) - 1, 0);
            slider.value = newValue;
            document.getElementById(`textSliderValue${lamp}`).innerText = newValue;
            const checkbox = document.getElementById(`lamp${lamp}Switch`);
            checkbox.checked = newValue > 0;
            lampState[lamp].brightness = newValue;
            fetch(`/brightness?lamp=${lamp}&value=${newValue}`);
        }

        // Toggle control functions
        function toggleLamp(lamp) {
            const checkbox = document.getElementById(`lamp${lamp}Switch`);
            const slider = document.getElementById(`pwmSlider${lamp}`);
            const newValue = checkbox.checked ? 100 : 0;
            slider.value = newValue;
            lampState[lamp].brightness = newValue;
            lampState[lamp].isOn = checkbox.checked;
            document.getElementById(`textSliderValue${lamp}`).innerText = newValue;
            fetch(`/toggle?lamp=${lamp}&value=${newValue}`);
        }

    // Function to import a profile from a JSON file
    function importProfile(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedProfile = JSON.parse(e.target.result);
                    const profileName = file.name.split('.').slice(0, -1).join('.'); // Extract the name from the file name without the extension
                    profiles[profileName] = importedProfile;
                    localStorage.setItem('profiles', JSON.stringify(profiles));

                    // Update lampState with the imported profile's lamps
                    Object.keys(importedProfile).forEach(lampId => {
                        lampState[lampId] = importedProfile[lampId];
                    });

                    // Update the profiles dropdown
                    const profilesDropdown = document.getElementById('profiles');
                    const option = document.createElement('option');
                    option.value = profileName;
                    option.text = profileName;
                    profilesDropdown.add(option);

                    // Select the imported profile
                    profilesDropdown.value = profileName;
                    displayLamp();

                    alert(`Profile "${profileName}" imported successfully!`);
                } catch (error) {
                    alert('Failed to import profile. Please ensure the file is a valid JSON.');
                }
            };
            reader.readAsText(file);
        }
    }

        // // Remove the selected saved profile and associated lamps
        // function removeProfile() {
        //     const selectedProfile = document.getElementById('profiles').value;
        //     if (selectedProfile && profiles[selectedProfile]) {
        //         const lampsToRemove = Object.keys(profiles[selectedProfile]);
        //         lampsToRemove.forEach(lamp => {
        //             delete lampState[lamp];
        //             const lampsDropdown = document.getElementById('lamps');
        //             for (let i = 0; i < lampsDropdown.options.length; i++) {
        //                 const option = lampsDropdown.options[i];
        //                 if (option.value === lamp) {
        //                     option.selected = false;
        //                     lampsDropdown.remove(i);
        //                     break;
        //                 }
        //             }
        //         });
        //         delete profiles[selectedProfile];
        //         const profilesDropdown = document.getElementById('profiles');
        //         for (let i = 0; i < profilesDropdown.options.length; i++) {
        //             const option = profilesDropdown.options[i];
        //             if (option.value === selectedProfile) {
        //                 option.selected = false;
        //                 profilesDropdown.remove(i);
        //                 break;
        //             }
        //         }

        //         displayLamp(); alert("Profile and associated lamps removed successfully!");
        //     }
        // }


        //TODO Check this fctn
        // Reload the predefined profiles and display the lamps
            // Reload the predefined profiles and display the lamps
            function reloadProfiles() {
                // Clear existing profiles and lamps
                profiles = {};
                const profilesDropdown = document.getElementById('profiles');
                profilesDropdown.innerHTML = ''; // Clear the profiles dropdown
                const lampsDropdown = document.getElementById('lamps');
                lampsDropdown.innerHTML = ''; // Clear the lamps dropdown
        
                // Load profiles from local storage
                const storedProfiles = JSON.parse(localStorage.getItem('profiles')) || {};
        
                // Update the profiles object and dropdown
                Object.keys(storedProfiles).forEach(profileName => {
                    profiles[profileName] = storedProfiles[profileName];
                    const option = document.createElement('option');
                    option.value = profileName;
                    option.text = profileName;
                    profilesDropdown.add(option);
                });
        
                // Select the first profile if available and display its lamps
                if (profilesDropdown.options.length > 0) {
                    profilesDropdown.selectedIndex = 0;
                    selectProfile();
                }
            }

        // Select a saved profile and display the lamps
        function selectProfile() {
            const selectedProfile = document.getElementById('profiles');
            const profileName = selectedProfile.value;
            if (profileName && profiles[profileName]) {
                const profileLamps = profiles[profileName];
                const lampsDropdown = document.getElementById('lamps');
                lampsDropdown.innerHTML = ''; // Clear the lamps dropdown

                // Retrieve custom names from localStorage
                Object.keys(profileLamps).forEach(lampKey => {
                    const lamp = profileLamps[lampKey];
                    const option = document.createElement('option');
                    option.value = lamp.id; 
                    option.text = lamp.name; // Retrieve custom names 
                    lampsDropdown.add(option);
                    
                    // Update the slider value and call updateSliderPWM for each lamp
                    const slider = document.getElementById(`pwmSlider${lamp.id}`);
                    if (slider) {
                        const sliderValue = lamp.brightness;
                        slider.value = sliderValue;
                        document.getElementById(`textSliderValue${lamp.id}`).innerText = sliderValue;
                        const checkbox = document.getElementById(`lamp${lamp.id}Switch`);
                        checkbox.checked = lamp.isOn;
                        lampState[lampKey].brightness = sliderValue;
                        lampState[lampKey].isOn = lamp.isOn;
                        fetch(`/brightness?lamp=${lamp.id}&value=${sliderValue}`);
                    }
                });
                displayLamp();
            }
        }
        // Add/ Save all the current lamps as a profile and then export the profiles
        function addAndExportProfile() {
            const profileName = prompt("Enter a name for the new profile:");
            if (profileName && !profiles[profileName]) {
                // Create a deep copy of the current lamp state
                const newProfile = JSON.parse(JSON.stringify(lampState));
                profiles[profileName] = newProfile;

                // Add the new profile to the profiles dropdown
                const profilesDropdown = document.getElementById('profiles');
                const option = document.createElement('option');
                option.value = profileName;
                option.text = profileName;
                profilesDropdown.add(option);
                // Save profiles to localStorage or server if needed
                localStorage.setItem('profiles', JSON.stringify(profiles));

                // Export the new profile as a JSON file
                const exportedProfile = JSON.stringify(profiles[profileName], null, 2); // Pretty print JSON
                const blob = new Blob([exportedProfile], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; 
                link.download = `${profileName}_profile.json`; // TODO set the correct PATH
                link.click();
                URL.revokeObjectURL(url);
                alert(`Profile "${profileName}" exported successfully!`);
            } else {
                alert("Profile name is either empty or already exists.");
                return; // Exit the function if the profile name is invalid
            }
        }
</script> 
</body>

</html>